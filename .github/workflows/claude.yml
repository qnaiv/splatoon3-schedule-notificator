name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      github.actor == 'qnaiv' && (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
        (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: write # Required for Claude to manage issue labels
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Verify owner access
        run: |
          echo "Workflow triggered by: ${{ github.actor }}"
          if [ "${{ github.actor }}" != "qnaiv" ]; then
            echo "âŒ Unauthorized access attempt by ${{ github.actor }}"
            echo "Only the repository owner (qnaiv) can use Claude Code."
            exit 1
          fi
          echo "âœ… Access authorized for owner: ${{ github.actor }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read
          
          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"
          
          # Optional: Customize the trigger phrase (default: @claude)
          # trigger_phrase: "/claude"
          
          # Optional: Trigger when specific user is assigned to an issue
          # assignee_trigger: "claude-bot"
          
          # Allow Claude to run lint and formatting commands (merged with main)
          allowed_tools: "Bash(npm install),Bash(npm run build),Bash(npm run dev),Bash(npm run preview),Bash(npm run fetch-schedule),Bash(npm run lint),Bash(npm run lint:fix),Bash(npm run format),Bash(npm run typecheck),Bash(git *),Bash(gh *)"
          
          # Custom instructions for Claude to customize its behavior for your project
          custom_instructions: |
            å¿…ãšæ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
            ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å†…å®¹ã¯ã™ã¹ã¦æ—¥æœ¬èªã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚
            GitHub flowã«å‰‡ã£ã¦é–‹ç™ºã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
            ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜ã‚„ææ¡ˆã‚‚æ—¥æœ¬èªã§è¡Œã£ã¦ãã ã•ã„ã€‚
            
            ## æ®µéšçš„é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹
            Issueã§ã®@claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ã€ä»¥ä¸‹ã®æ®µéšçš„ãƒ—ãƒ­ã‚»ã‚¹ã§å¯¾å¿œã—ã¦ãã ã•ã„ï¼š
            
            ### ãƒ•ã‚§ãƒ¼ã‚ºåˆ¤å®šæ–¹æ³•
            - Issueã®ãƒ©ãƒ™ãƒ«ã§ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’åˆ¤å®š
            - ãƒ©ãƒ™ãƒ«ãŒãªã„å ´åˆã¯è¦ä»¶å®šç¾©ãƒ•ã‚§ãƒ¼ã‚ºã‹ã‚‰é–‹å§‹
            - å„ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã«é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’è¨­å®š
            
            ### 1. è¦ä»¶å®šç¾©ãƒ•ã‚§ãƒ¼ã‚º (ãƒ©ãƒ™ãƒ«: phase:requirements)
            **ç›®çš„**: Issueå†…å®¹ã‚’æ­£ç¢ºã«ç†è§£ã—ã€è¦ä»¶ã‚’æ˜ç¢ºåŒ–
            **å®Ÿè¡Œå†…å®¹**:
            - Issueå†…å®¹ã®è©³ç´°åˆ†æ
            - è¦ä»¶ã®æ•´ç†ã¨æ˜ç¢ºåŒ–
            - æŠ€è¡“çš„åˆ¶ç´„ãƒ»å‰ææ¡ä»¶ã®ç¢ºèª
            - ä¸æ˜ç‚¹ãƒ»æ‡¸å¿µç‚¹ã‚’å…·ä½“çš„ã«è³ªå•
            - ã‚¹ã‚³ãƒ¼ãƒ—ã¨å„ªå…ˆåº¦ã®ç¢ºèª
            **å‡ºåŠ›å½¢å¼**:
            ```
            ## ğŸ“‹ è¦ä»¶å®šç¾©ãƒ•ã‚§ãƒ¼ã‚º
            
            ### ç†è§£ã—ãŸè¦ä»¶
            - [è¦ä»¶1]
            - [è¦ä»¶2]
            
            ### ç¢ºèªã—ãŸã„ç‚¹
            1. [è³ªå•1]
            2. [è³ªå•2]
            
            ### æŠ€è¡“çš„æ¤œè¨äº‹é …
            - [æ¤œè¨ç‚¹1]
            - [æ¤œè¨ç‚¹2]
            
            æ¬¡å›: å›ç­”ã„ãŸã ã„ãŸå¾Œã€è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºã«é€²ã¿ã¾ã™ã€‚
            ```
            **å®Œäº†æ¡ä»¶**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä¸æ˜ç‚¹ã¸ã®å›ç­”ã‚’å¾—ã‚‹
            
            ### 2. è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚º (ãƒ©ãƒ™ãƒ«: phase:design)
            **ç›®çš„**: å®Ÿè£…æ–¹é‡ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’è¨­è¨ˆ
            **å®Ÿè¡Œå†…å®¹**:
            - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ
            - ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ
            - æŠ€è¡“é¸å®šã®æ ¹æ‹ èª¬æ˜
            - å®Ÿè£…æ–¹é‡ã®è©³ç´°åŒ–
            - ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ»å‡¦ç†ãƒ•ãƒ­ãƒ¼ã®è¨­è¨ˆ
            **å‡ºåŠ›å½¢å¼**:
            ```
            ## ğŸ—ï¸ è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚º
            
            ### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ
            [è¨­è¨ˆæ¦‚è¦]
            
            ### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
            - [ãƒ•ã‚¡ã‚¤ãƒ«1]: [å½¹å‰²]
            - [ãƒ•ã‚¡ã‚¤ãƒ«2]: [å½¹å‰²]
            
            ### å®Ÿè£…æ–¹é‡
            1. [æ–¹é‡1]
            2. [æ–¹é‡2]
            
            ### æŠ€è¡“é¸å®š
            - [æŠ€è¡“]: [é¸å®šç†ç”±]
            
            ### ç–‘å•ç‚¹ãƒ»è¦ç¢ºèªäº‹é …
            [ã‚ã‚Œã°è³ªå•]
            ```
            **å®Œäº†æ¡ä»¶**: ç–‘å•ç‚¹ãŒãªããªã‚Šè¨­è¨ˆãŒå›ºã¾ã‚‹
            
            ### 3. è¨­è¨ˆç¢ºèªãƒ•ã‚§ãƒ¼ã‚º (ãƒ©ãƒ™ãƒ«: phase:design-review)
            **ç›®çš„**: è¨­è¨ˆå†…å®¹ã®æœ€çµ‚ç¢ºèªã¨å®Ÿè£…æ‰¿èª
            **å®Ÿè¡Œå†…å®¹**:
            - è¨­è¨ˆå†…å®¹ã®æœ€çµ‚ã‚µãƒãƒªãƒ¼
            - å®Ÿè£…äºˆå®šã®å…·ä½“çš„æç¤º
            - å½±éŸ¿ç¯„å›²ã®æ˜ç¢ºåŒ–
            - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã®æ˜ç¤ºçš„è¦æ±‚
            **å‡ºåŠ›å½¢å¼**:
            ```
            ## ğŸ” è¨­è¨ˆç¢ºèªãƒ•ã‚§ãƒ¼ã‚º
            
            ### æœ€çµ‚è¨­è¨ˆã‚µãƒãƒªãƒ¼
            [è¨­è¨ˆã®è¦ç´„]
            
            ### å®Ÿè£…äºˆå®š
            1. [å®Ÿè£…å†…å®¹1]
            2. [å®Ÿè£…å†…å®¹2]
            
            ### å½±éŸ¿ç¯„å›²
            - [å½±éŸ¿1]
            - [å½±éŸ¿2]
            
            **å®Ÿè£…é–‹å§‹ã®æ‰¿èªã‚’ãŠé¡˜ã„ã—ã¾ã™**
            æ‰¿èªã„ãŸã ã‘ã¾ã—ãŸã‚‰ã€æ¬¡å›@claudeã§å®Ÿè£…ã‚’é–‹å§‹ã—ã¾ã™ã€‚
            ```
            **å®Œäº†æ¡ä»¶**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®æ˜ç¤ºçš„ãªå®Ÿè£…æ‰¿èª
            
            ### 4. å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º (ãƒ©ãƒ™ãƒ«: phase:implementation)
            **ç›®çš„**: è¨­è¨ˆã«åŸºã¥ãå®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰å®Ÿè£…
            **å®Ÿè¡Œå†…å®¹**:
            - è¨­è¨ˆã«åŸºã¥ãå®Ÿè£…
            - ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ (lint, typecheck)
            - å¿…è¦ã«å¿œã˜ã¦ãƒ†ã‚¹ãƒˆä½œæˆ
            - PRä½œæˆ
            **å“è³ªãƒã‚§ãƒƒã‚¯**:
            - npm run lint ã§lintãƒã‚§ãƒƒã‚¯å¿…é ˆ
            - lintã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ npm run lint:fix ã§è‡ªå‹•ä¿®æ­£
            - npm run typecheck ã§TypeScriptãƒã‚§ãƒƒã‚¯
            - æœªä½¿ç”¨ã®importã‚„å¤‰æ•°ã¯å‰Šé™¤
            **å®Œäº†æ¡ä»¶**: PRä½œæˆã¨issueã‚¯ãƒ­ãƒ¼ã‚º
            
            ### ãƒ©ãƒ™ãƒ«ç®¡ç†
            å„ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã«é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š
            - `phase:requirements` - è¦ä»¶å®šç¾©ä¸­
            - `phase:design` - è¨­è¨ˆä¸­
            - `phase:design-review` - è¨­è¨ˆç¢ºèªä¸­
            - `phase:implementation` - å®Ÿè£…ä¸­
            - `phase:completed` - å®Œäº†
            
            ãƒ©ãƒ™ãƒ«è¨­å®šã«ã¯GitHub CLIã‚’ä½¿ç”¨ï¼š
            ```bash
            # ç¾åœ¨ã®ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ãƒ•ã‚§ãƒ¼ã‚ºãƒ©ãƒ™ãƒ«ã‚’è¨­å®š
            gh issue edit [issue-number] --remove-label "phase:requirements,phase:design,phase:design-review,phase:implementation" --add-label "phase:design"
            ```
            
            ### é‡è¦ãªåŸå‰‡
            - å„ãƒ•ã‚§ãƒ¼ã‚ºã‚’é£›ã°ã•ãšé †ç•ªã«å®Ÿè¡Œ
            - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ˜ç¤ºçš„ãªæ‰¿èªãªã—ã«æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã«é€²ã¾ãªã„
            - ç–‘å•ç‚¹ã¯å¿…ãšç¢ºèªã—ã¦ã‹ã‚‰é€²ã‚€
            - å®Ÿè£…å‰ã«ã¯å¿…ãšè¨­è¨ˆç¢ºèªãƒ•ã‚§ãƒ¼ã‚ºã‚’çµŒã‚‹
            - ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´æ™‚ã¯å¿…ãšãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ã™ã‚‹
          
          # Optional: Custom environment variables for Claude
          # claude_env: |
          #   NODE_ENV: test

